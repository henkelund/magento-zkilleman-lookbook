<?php
/**
 * Zkilleman_Lookbook
 *
 * Copyright (C) 2012 Henrik Hedelund (henke.hedelund@gmail.com)
 *
 * This file is part of Zkilleman_Lookbook.
 *
 * Zkilleman_Lookbook is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Zkilleman_Lookbook is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Zkilleman_Lookbook. If not, see <http://www.gnu.org/licenses/>.
 *
 * @category Zkilleman
 * @package Zkilleman_Lookbook
 * @author Henrik Hedelund <henke.hedelund@gmail.com>
 * @copyright 2012 Henrik Hedelund (henke.hedelund@gmail.com)
 * @license http://www.gnu.org/licenses/gpl.html GNU GPL
 * @link https://github.com/henkelund/magento-zkilleman-lookbook
 */
?>
<?php
    $images      = $this->getImageCollection();
    $imageWidth  = $this->getWidth();
    $imageHeight = $this->getHeight();
    $helper      = Mage::helper('lookbook');
    $canFilter   = Mage::getSingleton('lookbook/config')->isRequestTagsAllowed();
?>
<div class="slideshow-wrapper">
    <ul id="<?php echo $this->getHtmlId(); ?>" class="slideshow"><!--
    <?php foreach ($images as $image): ?>
     --><li class="image" data-id="<?php echo $image->getId(); ?>">
            <?php
                $bounds = array();
                $imgHtml = $image->getHtml(
                                $imageWidth,  // width
                                $imageHeight, // height
                                null,         // element attributes
                                null,         // style attributes
                                $bounds);     // post crop bounds relative 
                                              // to original aspect ratio
                $tagNames = array();
                $positionedTags = array();
                // Loading a collection within a loop is never ideal
                // Solution proposals:
                //   * Rely on block cache
                //   * Store serialized tag data on image table
                //   * Custom tag cache
                //   * Load tags with Ajax
                foreach ($image->getTags() as $tag) {
                    if ($tag->isInBounds($bounds)) {
                        $positionedTags[] = $tag;
                    }
                    $tagNames[] = $tag->getName();
                }
            ?>
         <?php echo $imgHtml; ?>
            <div class="overlay">
                <?php if (count($tagNames) > 0): ?>
                <div class="tags">
                    <label><?php echo $this->__('Tags:'); ?></label>
                    <?php $tagHtml = array(); ?>
                    <?php foreach ($tagNames as $tagName): ob_start(); ?>
                    <span class="tag<?php if ($this->tagIsActive($tagName)): ?> active<?php endif; ?>"><!--
                     --><?php if ($canFilter): ?><a href="<?php echo $helper->getTagUrl($tagName); ?>"><?php endif; ?><!--
                         --><?php echo $tagName; ?><!--
                     --><?php if ($canFilter): ?></a><?php endif; ?><!--
                 --></span>
                    <?php $tagHtml[] = trim(ob_get_clean()); endforeach; ?>
                    <?php echo implode(', ', $tagHtml); ?>
                </div>
                <?php endif; ?>
                <span class="title"><?php echo $image->getTitle(); ?></span>
                <p class="caption"><?php echo $image->getCaption(); ?></p>
            </div>
            <?php foreach ($positionedTags as $tag): ?>
            <div class="positioned-tag <?php echo $tag->getType(); ?><?php if ($this->tagIsActive($tag)): ?> active<?php endif; ?>"
                 data-id="<?php echo $tag->getId(); ?>"
                 data-type="<?php echo $tag->getType(); ?>"
                 data-x="<?php echo intval($tag->getRelativeX($bounds)*$imageWidth); ?>"
                 data-y="<?php echo intval($tag->getRelativeY($bounds)*$imageHeight); ?>"
                 style="display: none;">
                <?php if ($canFilter): ?>
                <a href="<?php echo $helper->getTagUrl($tag); ?>"><?php echo $tag->getName(); ?></a>
                <?php else: ?>
                <?php echo $tag->getName(); ?>
                <?php endif; ?>
            </div>
            <?php endforeach; ?>
        </li><!--
    <?php endforeach; ?>
 --></ul>
    <button class="previous" title="<?php echo $this->__('Previous'); ?>">&laquo;</button>
    <button class="next" title="<?php echo $this->__('Next'); ?>">&raquo;</button>
</div>
<script type="text/javascript">
    
    new LookbookSlideshow(
            '<?php echo $this->getHtmlId(); ?>',
            {
                direction: '<?php echo $this->getDirection(); ?>',
                interval:  <?php echo $this->getInterval(); ?>
            });
    
</script>
